{% extends 'core/base.html' %}
{% load humanize %}

{% block title %}Dashboard — All Minnesota{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="text-primary-green mb-4">Admin Dashboard</h1>

    <!-- Summary cards -->
    {% if goal %}
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="text-primary-green">Current Goal</h5>
                    <p class="mb-0">{{ goal.goal_title }} — ${{ goal.current_amount|floatformat:0|intcomma }} / ${{ goal.target_amount|floatformat:0|intcomma }}</p>
                    <a href="{% url 'core:goal_update' %}" class="btn btn-gold btn-sm mt-2">Update Goal</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="text-primary-green">Meals / Volunteers</h5>
                    <p class="mb-0">{{ goal.meals_funded|intcomma }} meals — {{ goal.volunteers_count|intcomma }} volunteers</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="text-primary-green">Quick Links</h5>
                    <a href="{% url 'core:kanban' %}" class="d-block">Tasks / Kanban</a>
                    <a href="{% url 'core:event_create' %}" class="d-block">Create Event</a>
                    <a href="{% url 'core:volunteer_list' %}" class="d-block">Volunteers</a>
                    <a href="{% url 'core:contact_list' %}" class="d-block">Contact Messages</a>
                </div>
            </div>
        </div>
    </div>
    <div class="row g-3 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="text-primary-green mb-2">Backend: Sites, Donations, Orders, Partners</h5>
                    <a href="{% url 'admin:core_distributionsite_changelist' %}" class="me-3">Distribution Sites</a>
                    <a href="{% url 'admin:core_donation_changelist' %}" class="me-3">Donations</a>
                    <a href="{% url 'admin:core_foodorder_changelist' %}" class="me-3">Food Orders</a>
                    <a href="{% url 'admin:core_mealkitdistribution_changelist' %}" class="me-3">Meal Kit Distributions</a>
                    <a href="{% url 'admin:core_partnerorganization_changelist' %}">Partner Organizations</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Kanban board -->
    <div class="row g-3 mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h3 class="text-primary-green mb-0">Task Board</h3>
            <a href="{% url 'core:task_create' %}" class="btn btn-gold btn-sm">New Task</a>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-secondary text-white py-2">
                    <strong>Backlog</strong>
                    <span class="badge bg-dark ms-1">{{ backlog|length }}</span>
                </div>
                <div class="card-body p-2 kanban-column">
                    {% for task in backlog %}
                    {% include 'core/admin/_task_card.html' with task=task task_form_action=request.path %}
                    {% empty %}
                    <p class="small text-muted mb-0 p-2">No tasks</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white py-2">
                    <strong>To Do</strong>
                    <span class="badge bg-dark ms-1">{{ to_do|length }}</span>
                </div>
                <div class="card-body p-2 kanban-column">
                    {% for task in to_do %}
                    {% include 'core/admin/_task_card.html' with task=task task_form_action=request.path %}
                    {% empty %}
                    <p class="small text-muted mb-0 p-2">No tasks</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white py-2" style="background-color: #C49A2C;">
                    <strong>In Progress</strong>
                    <span class="badge bg-dark ms-1">{{ in_progress|length }}</span>
                </div>
                <div class="card-body p-2 kanban-column">
                    {% for task in in_progress %}
                    {% include 'core/admin/_task_card.html' with task=task task_form_action=request.path %}
                    {% empty %}
                    <p class="small text-muted mb-0 p-2">No tasks</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white py-2">
                    <strong>Done</strong>
                    <span class="badge bg-dark ms-1">{{ done|length }}</span>
                </div>
                <div class="card-body p-2 kanban-column">
                    {% for task in done %}
                    {% include 'core/admin/_task_card.html' with task=task task_form_action=request.path %}
                    {% empty %}
                    <p class="small text-muted mb-0 p-2">No tasks</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-12">
            <a href="{% url 'core:kanban' %}" class="btn btn-outline-secondary btn-sm">Full Kanban board →</a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <h3 class="text-primary-green mb-3">Recent Volunteer Sign-Ups</h3>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr><th>Name</th><th>Email</th><th>Region</th><th>Date</th></tr>
                    </thead>
                    <tbody>
                        {% for v in recent_volunteers %}
                        <tr>
                            <td>{{ v.first_name }} {{ v.last_name }}</td>
                            <td>{{ v.email }}</td>
                            <td>{{ v.get_region_display }}</td>
                            <td>{{ v.submitted_at|date:"M j, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-muted">No sign-ups yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="{% url 'core:volunteer_list' %}" class="btn btn-outline-primary-green btn-sm">View All</a>
        </div>
        <div class="col-lg-6 mb-4">
            <h3 class="text-primary-green mb-3">Recent Contact Messages</h3>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr><th>Name</th><th>Subject</th><th>Date</th></tr>
                    </thead>
                    <tbody>
                        {% for c in recent_contacts %}
                        <tr>
                            <td>{{ c.name }}</td>
                            <td>{{ c.subject|truncatewords:5 }}</td>
                            <td>{{ c.submitted_at|date:"M j, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-muted">No messages yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="{% url 'core:contact_list' %}" class="btn btn-outline-primary-green btn-sm">View All</a>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <h3 class="text-primary-green mb-3">Events</h3>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr><th>Title</th><th>Date</th><th>Venue</th><th>Published</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        {% for event in events %}
                        <tr>
                            <td>{{ event.title }}</td>
                            <td>{{ event.date|date:"M j, Y" }}</td>
                            <td>{{ event.venue_name }}</td>
                            <td>{% if event.is_published %}Yes{% else %}No{% endif %}</td>
                            <td>
                                <a href="{% url 'core:event_edit' event.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                <a href="{% url 'core:event_delete' event.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-muted">No events.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h3 class="text-primary-green mb-3">Last 5 Impact Updates</h3>
            <ul class="list-group list-group-flush">
                {% for u in recent_impact %}
                <li class="list-group-item d-flex justify-content-between">
                    <span>${{ u.amount_raised|floatformat:0 }} — {{ u.meals_funded }} meals — {{ u.volunteers }} volunteers</span>
                    <small class="text-muted">{{ u.updated_at|date:"M j, Y" }} ({{ u.updated_by.get_full_name|default:u.updated_by.username }})</small>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">No impact updates yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}
